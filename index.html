<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fan Review</title>
  <link rel="icon" href="data:,">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial,sans-serif;max-width:600px;margin:2rem auto;padding:0 1rem;}
    h1{text-align:center;}
    label{display:block;margin:10px 0 4px;font-weight:bold;}
    input,select,textarea{width:100%;padding:8px;font-size:1rem;border:1px solid #ccc;border-radius:4px;}
    button{margin-top:20px;padding:12px 24px;background:#0066ff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:1rem;}
    button:disabled{background:#aaa;cursor:not-allowed;}
    .msg{margin-top:15px;padding:12px;border-radius:4px;text-align:center;}
    .success{background:#d4edda;color:#155724;}
    .error{background:#f8d7da;color:#721c24;}
    .preview img, .preview video{max-width:100%;margin-top:10px;border-radius:8px;}
  </style>
</head>
<body>

<h1>Fan Review</h1>

<form id="form">
  <label>Your Name *</label>
  <input type="text" name="fan name" required>

  <label>Show Attended *</label>
  <input type="text" name="show attended" required placeholder="e.g. Taylor Swift â€“ The Eras Tour">

  <label>Artist Reviewed *</label>
  <input type="text" name="artist reviewed" required placeholder="e.g. Taylor Swift">

  <label>Date of Show *</label>
  <input type="date" name="date" required>

  <fieldset>
    <legend>Rate (1 = low, 5 = high)</legend>
    <label>Rating <input type="number" name="rating" min="1" max="5" required></label>
    <label>Energy <input type="number" name="energy" min="1" max="5" required></label>
    <label>Stage Presence <input type="number" name="stage presence" min="1" max="5" required></label>
    <label>Crowd Reaction <input type="number" name="crowd reaction" min="1" max="5" required></label>
    <label>Originality <input type="number" name="originality" min="1" max="5" required></label>
    <label>Musicianship <input type="number" name="musicianship" min="1" max="5" required></label>
  </fieldset>

  <label>Standout Moment</label>
  <textarea name="standout moment" rows="2"></textarea>

  <label>Live Presence</label>
  <textarea name="live presence" rows="2"></textarea>

  <label>Recommend Artist?</label>
  <select name="recommend artist">
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>How Did You Discover?</label>
  <select name="discovery source">
    <option value="Social Media">Social Media</option>
    <option value="Friend">Friend</option>
    <option value="Radio">Radio</option>
    <option value="Other">Other</option>
  </select>

  <label>How Many Shows Have You Seen?</label>
  <input type="number" name="show count" min="0">

  <label>Review Influence (1-10)</label>
  <input type="number" name="review weight" min="1" max="10">

  <label>Upload Photo/Video (optional)</label>
  <input type="file" id="file" name="media upload" accept="image/*,video/*">
  <div class="preview" id="preview"></div>

  <button type="submit" id="btn">Submit Review</button>
</form>

<div id="msg" class="msg"></div>

<script type="module">
  const SUPABASE_URL = 'https://qwickgmrhqdnqaqxuuwk.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3aWNrZ21yaHFkbnFhcXh1dXdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3ODA4OTEsImV4cCI6MjA3NTM1Njg5MX0.CxC1nH6Xvrggn_VNMmjuomeQQVdAfCwyPHJU81ZGjOM';
  const BUCKET = 'review-media';
  const TABLE = 'fan_reviews';

  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const msg = document.getElementById('msg');
  const preview = document.getElementById('preview');
  const btn = document.getElementById('btn');

  document.getElementById('file').onchange = e => {
    const file = e.target.files[0];
    preview.innerHTML = '';
    if (file) {
      const url = URL.createObjectURL(file);
      if (file.type.startsWith('image/')) preview.innerHTML = `<img src="${url}">`;
      if (file.type.startsWith('video/')) preview.innerHTML = `<video src="${url}" controls></video>`;
    }
  };

  document.getElementById('form').onsubmit = async e => {
    e.preventDefault();
    btn.disabled = true;
    msg.textContent = 'Submitting...';
    msg.className = 'msg';

    const form = new FormData(e.target);
    const data = {};
    for (let [k, v] of form.entries()) {
      if (k !== 'media upload') data[k] = v;
    }

    // Upload media
    if (form.get('media upload')?.size > 0) {
      const file = form.get('media upload');
      const ext = file.name.split('.').pop();
      const path = `reviews/${Date.now()}_${Math.random().toString(36).slice(2, 9)}.${ext}`;
      const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, file);
      if (upErr) {
        msg.textContent = 'Upload failed: ' + upErr.message;
        msg.className = 'msg error';
        btn.disabled = false;
        return;
      }
      const { data: urlData } = supabase.storage.from(BUCKET).getPublicUrl(path);
      data['media upload'] = urlData.publicUrl;
    }

    // Insert into fan_reviews
    const { error } = await supabase.from(TABLE).insert([data]);

    if (error) {
      msg.textContent = 'Error: ' + error.message;
      msg.className = 'msg error';
    } else {
      msg.textContent = 'Review saved! Thank you!';
      msg.className = 'msg success';
      e.target.reset();
      preview.innerHTML = '';
    }
    btn.disabled = false;
  };
</script>
</body>
</html>
