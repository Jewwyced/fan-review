<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fan Review</title>
  <link rel="icon" href="data:,">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial,sans-serif;max-width:600px;margin:2rem auto;padding:0 1rem;}
    h1{text-align:center;}
    label{display:block;margin:10px 0 4px;font-weight:bold;}
    input,select,textarea{width:100%;padding:8px;font-size:1rem;border:1px solid #ccc;border-radius:4px;}
    button{margin-top:20px;padding:12px 24px;background:#0066ff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:1rem;}
    button:disabled{background:#aaa;cursor:not-allowed;}
    .msg{margin-top:15px;padding:12px;border-radius:4px;text-align:center;}
    .success{background:#d4edda;color:#155724;}
    .error{background:#f8d7da;color:#721c24;}
    .preview img, .preview video{max-width:100%;margin-top:10px;border-radius:8px;}
  </style>
</head>
<body>

<h1>Fan Review</h1>

<form id="form">
  <label>Your Name *</label>
  <input type="text" name="fan_name" required>

  <label>Show Attended *</label>
  <input type="text" name="show_attended" required>

  <label>Artist Reviewed *</label>
  <input type="text" name="artist_reviewed" required>

  <label>Date of Show *</label>
  <input type="date" name="date" required>

  <fieldset>
    <legend>Rate (1–5)</legend>
    <label>Rating <input type="number" name="rating" min="1" max="5" required></label>
    <label>Energy <input type="number" name="energy" min="1" max="5" required></label>
    <label>Stage Presence <input type="number" name="stage_presence" min="1" max="5" required></label>
    <label>Crowd Reaction <input type="number" name="crowd_reaction" min="1" max="5" required></label>
    <label>Originality <input type="number" name="originality" min="1" max="5" required></label>
    <label>Musicianship <input type="number" name="musicianship" min="1" max="5" required></label>
  </fieldset>

  <label>Standout Moment</label>
  <textarea name="standout_moment" rows="2"></textarea>

  <label>Live Presence</label>
  <textarea name="live_presence" rows="2"></textarea>

  <label>Recommend Artist?</label>
  <select name="recommend_artist">
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>How Did You Discover?</label>
  <select name="discovery_source">
    <option value="Social Media">Social Media</option>
    <option value="Friend">Friend</option>
    <option value="Radio">Radio</option>
    <option value="Other">Other</option>
  </select>

  <label>Review Weight (1–10)</label>
  <input type="number" name="review_weight" min="1" max="10">

  <label>Upload Photo/Video</label>
  <input type="file" id="file" name="media_upload" accept="image/*,video/*">
  <div class="preview" id="preview"></div>

  <button type="submit" id="btn">Submit Review</button>
</form>

<div id="msg" class="msg"></div>

<script type="module">
  const SUPABASE_URL = 'https://qwickgmrhqdnqaqxuuwk.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3aWNrZ21yaHFkbnFhcXh1dXdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3ODA4OTEsImV4cCI6MjA3NTM1Njg5MX0.CxC1nH6Xvrggn_VNMmjuomeQQVdAfCwyPHJU81ZGjOM';
  const BUCKET = 'review-media';
  const TABLE = 'fan_reviews';

  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const msg = document.getElementById('msg');
  const preview = document.getElementById('preview');
  const btn = document.getElementById('btn');

  document.getElementById('file').onchange = e => {
    const file = e.target.files[0];
    preview.innerHTML = '';
    if (file) {
      const url = URL.createObjectURL(file);
      preview.innerHTML = file.type.startsWith('image/') 
        ? `<img src="${url}">` 
        : `<video src="${url}" controls></video>`;
    }
  };

  document.getElementById('form').onsubmit = async e => {
    e.preventDefault();
    btn.disabled = true;
    msg.textContent = 'Submitting...';
    msg.className = 'msg';

    const form = new FormData(e.target);
    const now = new Date().toISOString();

    // GENERATE UNIQUE review_id
    const review_id = `rev_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    const data = {
      review_id: review_id,
      fan_name: form.get('fan_name'),
      show_attended: form.get('show_attended'),
      artist_reviewed: form.get('artist_reviewed'),
      date: form.get('date'),
      rating: parseInt(form.get('rating')),
      energy: parseInt(form.get('energy')),
      stage_presence: parseInt(form.get('stage_presence')),
      crowd_reaction: parseInt(form.get('crowd_reaction')),
      originality: parseInt(form.get('originality')),
      musicianship: parseInt(form.get('musicianship')),
      standout_moment: form.get('standout_moment'),
      live_presence: form.get('live_presence'),
      recommend_artist: form.get('recommend_artist'),
      discovery_source: form.get('discovery_source'),
      review_weight: form.get('review_weight') ? parseInt(form.get('review_weight')) : null,
      created_time: now,
      hours_since: 0,
      has_media: false
    };

    // Upload media
    const file = form.get('media_upload');
    if (file && file.size > 0) {
      const ext = file.name.split('.').pop();
      const path = `reviews/${review_id}.${ext}`;
      const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, file, { upsert: true });
      if (upErr && upErr.message !== 'The resource already exists') {
        msg.textContent = 'Upload failed: ' + upErr.message;
        msg.className = 'msg error';
        btn.disabled = false;
        return;
      }
      const { data: urlData } = supabase.storage.from(BUCKET).getPublicUrl(path);
      data['media_upload'] = urlData.publicUrl;
      data['has_media'] = true;
    }

    // INSERT WITH UPSERT TO PREVENT DUPLICATES
    const { error } = await supabase
      .from(TABLE)
      .upsert([data], { onConflict: 'review_id' });

    if (error) {
      msg.textContent = 'Error: ' + error.message;
      msg.className = 'msg error';
    } else {
      msg.textContent = 'Review saved! Thank you!';
      msg.className = 'msg success';
      e.target.reset();
      preview.innerHTML = '';
    }
    btn.disabled = false;
  };
</script>
</body>
</html>
